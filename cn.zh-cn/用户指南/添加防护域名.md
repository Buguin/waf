# 添加防护域名<a name="waf_01_0002"></a>

该任务指导用户在Web应用防火墙添加并接入域名。域名接入WAF后，WAF作为一个反向代理存在于客户端和服务器之间，服务器的真实IP被隐藏起来，Web访问者只能看到WAF的IP地址。

## 前提条件<a name="section2256777914731"></a>

已获取管理控制台的帐号和密码。

## 配置防护域名原理图<a name="section155061806348"></a>

-   若在客户端和Web应用防火墙之间使用了代理，可参照[图1](#fig030435404518)配置。

    **图 1**  使用代理配置原理图<a name="fig030435404518"></a>  
    ![](figures/使用代理配置原理图.png "使用代理配置原理图")


-   若在客户端和Web应用防火墙之间未使用代理，可参照[图2](#fig1624119317528)配置。

    **图 2**  未使用代理配置原理图<a name="fig1624119317528"></a>  
    ![](figures/未使用代理配置原理图.png "未使用代理配置原理图")


## 操作步骤<a name="section18585791172619"></a>

1.  登录管理控制台（https://console.huaweicloud.com/）。
2.  单击管理控制台左上角的![](figures/选择区域图标.jpg)，选择区域或项目。
3.  单击页面上方的“服务列表“，选择“安全  \>  Web应用防火墙“。
4.  在左侧导航树中选择“域名配置“，进入“域名配置“页面，如[图3](#fig15593418182219)所示。

    **图 3**  添加防护域名<a name="fig15593418182219"></a>  
    ![](figures/添加防护域名.png "添加防护域名")

5.  在域名列表左上角，单击“添加防护域名“。
6.  在“添加防护域名“页面配置域名基本信息。如[图4](#fig175731754141418)所示，相关参数说明如[表1](#table7692122554811)所示。

    **图 4**  配置基本信息<a name="fig175731754141418"></a>  
    ![](figures/配置基本信息.jpg "配置基本信息")

    **表 1**  基本信息参数说明

    <a name="table7692122554811"></a>
    <table><thead align="left"><tr id="row1068752517484"><th class="cellrowborder" valign="top" width="15%" id="mcps1.2.4.1.1"><p id="p768742524817"><a name="p768742524817"></a><a name="p768742524817"></a>参数</p>
    </th>
    <th class="cellrowborder" valign="top" width="60.5%" id="mcps1.2.4.1.2"><p id="p1168782534812"><a name="p1168782534812"></a><a name="p1168782534812"></a>参数说明</p>
    </th>
    <th class="cellrowborder" valign="top" width="24.5%" id="mcps1.2.4.1.3"><p id="p12687162544815"><a name="p12687162544815"></a><a name="p12687162544815"></a>取值样例</p>
    </th>
    </tr>
    </thead>
    <tbody><tr id="row1368718254486"><td class="cellrowborder" valign="top" width="15%" headers="mcps1.2.4.1.1 "><p id="p368762516486"><a name="p368762516486"></a><a name="p368762516486"></a>防护域名</p>
    </td>
    <td class="cellrowborder" valign="top" width="60.5%" headers="mcps1.2.4.1.2 "><p id="p168710252489"><a name="p168710252489"></a><a name="p168710252489"></a>可防护的域名，支持单域名和泛域名。</p>
    <a name="ul9206119142513"></a><a name="ul9206119142513"></a><ul id="ul9206119142513"><li>单域名：输入防护的单域名。例如：www.example.com。</li><li>泛域名<a name="ul776103520251"></a><a name="ul776103520251"></a><ul id="ul776103520251"><li>如果各子域名对应的服务器IP地址相同：输入防护的泛域名。例如：*.example.com。</li><li>如果各子域名对应的服务器IP地址不相同：请将子域名按<span class="parmname" id="parmname13761925124915"><a name="parmname13761925124915"></a><a name="parmname13761925124915"></a>“单域名”</span>方式逐条添加。</li></ul>
    </li></ul>
    </td>
    <td class="cellrowborder" valign="top" width="24.5%" headers="mcps1.2.4.1.3 "><p id="p1268714259482"><a name="p1268714259482"></a><a name="p1268714259482"></a>单域名：www.example.com</p>
    <p id="p176877251487"><a name="p176877251487"></a><a name="p176877251487"></a>泛域名：*.example.com</p>
    </td>
    </tr>
    <tr id="row116884252488"><td class="cellrowborder" valign="top" width="15%" headers="mcps1.2.4.1.1 "><p id="p468762516482"><a name="p468762516482"></a><a name="p468762516482"></a>端口</p>
    </td>
    <td class="cellrowborder" valign="top" width="60.5%" headers="mcps1.2.4.1.2 "><p id="p8687182544810"><a name="p8687182544810"></a><a name="p8687182544810"></a>可选参数，仅当用户勾选<span class="parmname" id="parmname15687162544812"><a name="parmname15687162544812"></a><a name="parmname15687162544812"></a>“非标准端口”</span>时需要配置。</p>
    <a name="ul86882025104815"></a><a name="ul86882025104815"></a><ul id="ul86882025104815"><li><span class="parmname" id="parmname268752554811"><a name="parmname268752554811"></a><a name="parmname268752554811"></a>“对外协议”</span>选择<span class="parmvalue" id="parmvalue1368772515487"><a name="parmvalue1368772515487"></a><a name="parmvalue1368772515487"></a>“HTTP”</span>时，WAF默认防护<span class="parmvalue" id="parmvalue176871525194810"><a name="parmvalue176871525194810"></a><a name="parmvalue176871525194810"></a>“80”</span>标准端口的业务，如需配置除<span class="parmvalue" id="parmvalue268714258481"><a name="parmvalue268714258481"></a><a name="parmvalue268714258481"></a>“80”</span>以外的端口，勾选<span class="parmname" id="parmname96871825134813"><a name="parmname96871825134813"></a><a name="parmname96871825134813"></a>“非标准端口”</span>，在<span class="parmname" id="parmname156881251484"><a name="parmname156881251484"></a><a name="parmname156881251484"></a>“端口”</span>下拉列表中选择非标准端口。</li><li><span class="parmname" id="parmname46881325184815"><a name="parmname46881325184815"></a><a name="parmname46881325184815"></a>“对外协议”</span>选择<span class="parmvalue" id="parmvalue96881725124816"><a name="parmvalue96881725124816"></a><a name="parmvalue96881725124816"></a>“HTTPS”</span>时，WAF默认防护<span class="parmvalue" id="parmvalue10688122517488"><a name="parmvalue10688122517488"></a><a name="parmvalue10688122517488"></a>“443”</span>标准端口的业务，如需配置除<span class="parmvalue" id="parmvalue1068882594811"><a name="parmvalue1068882594811"></a><a name="parmvalue1068882594811"></a>“443”</span>以外的端口，勾选<span class="parmname" id="parmname136881725194811"><a name="parmname136881725194811"></a><a name="parmname136881725194811"></a>“非标准端口”</span>，在<span class="parmname" id="parmname1768815250489"><a name="parmname1768815250489"></a><a name="parmname1768815250489"></a>“端口”</span>下拉列表中选择非标准端口。</li></ul>
    <p id="p12688525104820"><a name="p12688525104820"></a><a name="p12688525104820"></a>Web应用防火墙可支持非标准端口169个（HTTP业务端口146个，HTTPS业务端口23个）。</p>
    </td>
    <td class="cellrowborder" valign="top" width="24.5%" headers="mcps1.2.4.1.3 "><p id="p86881725164816"><a name="p86881725164816"></a><a name="p86881725164816"></a>81</p>
    </td>
    </tr>
    <tr id="row5690192514820"><td class="cellrowborder" valign="top" width="15%" headers="mcps1.2.4.1.1 "><p id="p116898254489"><a name="p116898254489"></a><a name="p116898254489"></a>服务器配置</p>
    </td>
    <td class="cellrowborder" valign="top" width="60.5%" headers="mcps1.2.4.1.2 "><p id="p568972554814"><a name="p568972554814"></a><a name="p568972554814"></a>网站服务器地址的配置。包括对外协议、源站协议、源站地址和源站端口。</p>
    <a name="ul16689625134815"></a><a name="ul16689625134815"></a><ul id="ul16689625134815"><li>对外协议：客户端协议类型。包括<span class="parmvalue" id="parmvalue468962564815"><a name="parmvalue468962564815"></a><a name="parmvalue468962564815"></a>“HTTP”</span>、<span class="parmvalue" id="parmvalue1068932514812"><a name="parmvalue1068932514812"></a><a name="parmvalue1068932514812"></a>“HTTPS”</span>两种协议类型。</li><li>源站协议：服务器协议类型，WAF转发客户端请求的协议。包括<span class="parmvalue" id="parmvalue66891325124819"><a name="parmvalue66891325124819"></a><a name="parmvalue66891325124819"></a>“HTTP”</span>、<span class="parmvalue" id="parmvalue1968972511483"><a name="parmvalue1968972511483"></a><a name="parmvalue1968972511483"></a>“HTTPS”</span>两种协议类型。<div class="note" id="note031411715256"><a name="note031411715256"></a><a name="note031411715256"></a><span class="notetitle"> 说明： </span><div class="notebody"><p id="p113161117172510"><a name="p113161117172510"></a><a name="p113161117172510"></a>对外协议与源站协议的具体配置规则，请参见<a href="#section645014318511">对外协议与源站协议配置规则</a>。</p>
    </div></div>
    </li><li>源站地址：客户端访问的网站服务器的IP地址（一般对应该域名接入WAF之前的A记录）或者域名（一般对应该域名接入前的CNAME）。</li><li>源站端口：客户端访问的网站服务器的端口号。</li></ul>
    </td>
    <td class="cellrowborder" valign="top" width="24.5%" headers="mcps1.2.4.1.3 "><p id="p20689192524820"><a name="p20689192524820"></a><a name="p20689192524820"></a>对外协议：HTTPS</p>
    <p id="p568922544813"><a name="p568922544813"></a><a name="p568922544813"></a>源站协议：HTTPS</p>
    <p id="p1368915251486"><a name="p1368915251486"></a><a name="p1368915251486"></a>源站地址：192.168.1.1</p>
    <p id="p13689162510483"><a name="p13689162510483"></a><a name="p13689162510483"></a>源站端口：443</p>
    </td>
    </tr>
    <tr id="row76909251484"><td class="cellrowborder" valign="top" width="15%" headers="mcps1.2.4.1.1 "><p id="p169072504811"><a name="p169072504811"></a><a name="p169072504811"></a>证书</p>
    </td>
    <td class="cellrowborder" valign="top" width="60.5%" headers="mcps1.2.4.1.2 "><p id="p1223816455594"><a name="p1223816455594"></a><a name="p1223816455594"></a><span class="parmname" id="parmname52381945115920"><a name="parmname52381945115920"></a><a name="parmname52381945115920"></a>“对外协议”</span>设置为<span class="parmvalue" id="parmvalue122381445155916"><a name="parmvalue122381445155916"></a><a name="parmvalue122381445155916"></a>“HTTPS”</span>时，需要选择已有证书或导入新证书，导入新证书的操作请参见<a href="#li1098265701316">7</a>。</p>
    </td>
    <td class="cellrowborder" valign="top" width="24.5%" headers="mcps1.2.4.1.3 "><p id="p86901825134813"><a name="p86901825134813"></a><a name="p86901825134813"></a>--</p>
    </td>
    </tr>
    </tbody>
    </table>

7.  <a name="li1098265701316"></a>（可选）导入新证书。

    当“对外协议“设置为“HTTPS“时，可以导入新证书。

    1.  单击“导入新证书“，打开“导入新证书“对话框。然后输入“证书名称“，并将证书内容和私钥内容粘贴到对应的文本框中，如[图5](#fig7846148397)所示。

        **图 5**  导入新证书<a name="fig7846148397"></a>  
        ![](figures/导入新证书.png "导入新证书")

        >![](public_sys-resources/icon-note.gif) **说明：**   
        >Web应用防火墙将对私钥进行加密保存，保障证书私钥的安全性。  

        WAF当前仅支持PEM格式证书。如果证书为非PEM格式，请参考[表2](#table1184924815910)将证书转换为PEM格式，再粘贴到“证书内容“和“私钥内容“文本框中。 

        **表 2**  证书转换命令

        <a name="table1184924815910"></a>
        <table><thead align="left"><tr id="row2847448797"><th class="cellrowborder" valign="top" width="21.990000000000002%" id="mcps1.2.3.1.1"><p id="p98475489920"><a name="p98475489920"></a><a name="p98475489920"></a>格式类型</p>
        </th>
        <th class="cellrowborder" valign="top" width="78.01%" id="mcps1.2.3.1.2"><p id="p18847164813920"><a name="p18847164813920"></a><a name="p18847164813920"></a>转换方式（Linux系统中操作）</p>
        </th>
        </tr>
        </thead>
        <tbody><tr id="row1784719481093"><td class="cellrowborder" valign="top" width="21.990000000000002%" headers="mcps1.2.3.1.1 "><p id="p68471489919"><a name="p68471489919"></a><a name="p68471489919"></a>CER/CRT</p>
        </td>
        <td class="cellrowborder" valign="top" width="78.01%" headers="mcps1.2.3.1.2 "><p id="p88479481916"><a name="p88479481916"></a><a name="p88479481916"></a>将<span class="filepath" id="filepath78476481915"><a name="filepath78476481915"></a><a name="filepath78476481915"></a>“cert.crt”</span>证书文件直接重命名为<span class="filepath" id="filepath98475485919"><a name="filepath98475485919"></a><a name="filepath98475485919"></a>“cert.pem”</span>。</p>
        </td>
        </tr>
        <tr id="row1484714481196"><td class="cellrowborder" valign="top" width="21.990000000000002%" headers="mcps1.2.3.1.1 "><p id="p14847164816915"><a name="p14847164816915"></a><a name="p14847164816915"></a>PFX</p>
        </td>
        <td class="cellrowborder" valign="top" width="78.01%" headers="mcps1.2.3.1.2 "><a name="ol178472048299"></a><a name="ol178472048299"></a><ol id="ol178472048299"><li>提取私钥命令，以<span class="filepath" id="filepath1584712483914"><a name="filepath1584712483914"></a><a name="filepath1584712483914"></a>“cert.pfx”</span>转换为<span class="filepath" id="filepath17847184810916"><a name="filepath17847184810916"></a><a name="filepath17847184810916"></a>“cert.key”</span>为例。<p id="p18476481912"><a name="p18476481912"></a><a name="p18476481912"></a><strong id="b78471748295"><a name="b78471748295"></a><a name="b78471748295"></a>openssl pkcs12 -in cert.pfx -nocerts -out cert.key -nodes</strong></p>
        </li><li>提取证书命令（示例：<span class="filepath" id="filepath148471048490"><a name="filepath148471048490"></a><a name="filepath148471048490"></a>“cert.pfx”</span>转<span class="filepath" id="filepath68471648499"><a name="filepath68471648499"></a><a name="filepath68471648499"></a>“cert.pem”</span>）：<p id="p168471248296"><a name="p168471248296"></a><a name="p168471248296"></a><strong id="b10847164818913"><a name="b10847164818913"></a><a name="b10847164818913"></a>openssl pkcs12 -in cert.pfx -nokeys -out cert.pem</strong></p>
        </li></ol>
        </td>
        </tr>
        <tr id="row15847548495"><td class="cellrowborder" valign="top" width="21.990000000000002%" headers="mcps1.2.3.1.1 "><p id="p12847448399"><a name="p12847448399"></a><a name="p12847448399"></a>P7B</p>
        </td>
        <td class="cellrowborder" valign="top" width="78.01%" headers="mcps1.2.3.1.2 "><p id="p784720481898"><a name="p784720481898"></a><a name="p784720481898"></a>证书转换，以<span class="filepath" id="filepath3847154818919"><a name="filepath3847154818919"></a><a name="filepath3847154818919"></a>“cert.p7b”</span>转换为<span class="filepath" id="filepath784716482919"><a name="filepath784716482919"></a><a name="filepath784716482919"></a>“cert.pem”</span>为例。</p>
        <p id="p384734812910"><a name="p384734812910"></a><a name="p384734812910"></a><strong id="b884754812912"><a name="b884754812912"></a><a name="b884754812912"></a>openssl pkcs7 -print_certs -in cert.p7b -out cert.pem</strong></p>
        </td>
        </tr>
        <tr id="row12849154819915"><td class="cellrowborder" valign="top" width="21.990000000000002%" headers="mcps1.2.3.1.1 "><p id="p1984713481495"><a name="p1984713481495"></a><a name="p1984713481495"></a>DER</p>
        </td>
        <td class="cellrowborder" valign="top" width="78.01%" headers="mcps1.2.3.1.2 "><p id="p208499482912"><a name="p208499482912"></a><a name="p208499482912"></a>提取证书命令，以<span class="filepath" id="filepath984724810917"><a name="filepath984724810917"></a><a name="filepath984724810917"></a>“privatekey.der”</span>转换为<span class="filepath" id="filepath8849148993"><a name="filepath8849148993"></a><a name="filepath8849148993"></a>“cert.key”</span>为例。</p>
        <p id="p118496487916"><a name="p118496487916"></a><a name="p118496487916"></a><strong id="b118494481997"><a name="b118494481997"></a><a name="b118494481997"></a>openssl rsa -inform DER -outform PEM -in privatekey.der -out cert.key</strong></p>
        </td>
        </tr>
        </tbody>
        </table>

    2.  单击“上传“，上传证书。

8.  选择“是否已使用代理“，默认为“否“。

    >![](public_sys-resources/icon-notice.gif) **注意：**   
    >当在Web应用防火墙前使用代理时，不能切换为“Bypassed“工作模式。  

    -   若接入Web应用防火墙的网站已使用高防、CDN（Content Delivery Network，内容分发网络）、云加速等代理，为了保证WAF的安全策略能够针对真实源IP生效，请务必选择“是“，如果选择“否“，则Web应用防火墙无法获取Web访问者请求的真实IP地址。
    -   若接入Web应用防火墙的网站未使用任何代理，请选择“否“。

9.  单击“下一步“，进入“域名接入“页面，同时在页面的右上角，会弹出“域名添加成功“。

    >![](public_sys-resources/icon-note.gif) **说明：**   
    >-   如果暂时不接入域名，可跳过本步骤，直接单击“下一步“后单击“完成“。后续再参照[域名接入](域名接入.md)章节完成域名接入。  
    >-   未接入域名或域名接入失败，“DNS解析状态“显示“异常“。  

    -   若使用了CDN或高防等代理类服务，需要配置回源地址、子域名和TXT记录。如[图6](#zh-cn_topic_0110861266_fig450482413592)所示。

        **图 6**  域名接入<a name="zh-cn_topic_0110861266_fig450482413592"></a>  
        ![](figures/域名接入.jpg "域名接入")

        1.  配置网站使用代理的“回源地址“。

            根据[图6](#zh-cn_topic_0110861266_fig450482413592)提示，将CDN或高防等代理中的回源地址修改为WAF生成的回源地址。

        2.  配置“子域名“和“TXT记录“。

            根据[图6](#zh-cn_topic_0110861266_fig450482413592)提示，前往您的DNS服务商处，添加一个“子域名“，并为该子域名添加一条“TXT记录“。


    -   未使用代理，需要配置CNAME记录。如[图7](#zh-cn_topic_0110861266_fig84741317702)所示。

        **图 7**  接入域名（CNAME记录）<a name="zh-cn_topic_0110861266_fig84741317702"></a>  
        ![](figures/接入域名（CNAME记录）.png "接入域名（CNAME记录）")

        1.  到该域名的DNS服务商处，配置防护域名的别名解析，具体操作请咨询您的域名服务提供商。

            以下为当前主流的域名服务商的CNAME绑定方法，仅供参考。如与实际配置不符，请以各自域名服务商的信息为准。

            1.  登录域名服务提供商（如：万网、DNSPod、新网）的管理控制台。
            2.  进入域名解析记录页。
            3.  设置CNAME解析记录。
                -   “记录类型“选择为“CNAME“。
                -   “主机记录“一般填写域名前缀，例如：防护域名为 “admin.demo.com“，“主机记录“填写为“admin“。
                -   “记录值“填写为WAF生成的CNAME，例如： “xxxxxxx.waf.huaweicloud.com“。
                -   “解析线路“，“TTL“  保持默认值即可。

            4.  填写完成后，单击“保存“，完成解析设置。

            >![](public_sys-resources/icon-notice.gif) **注意：**   
            >以上解析方法为第三方解析方法。本文档不对任何第三方内容进行控制或负责，包括但不限于其准确性、兼容性、可靠性、可用性、合法性、适当性、性能、不侵权、更新状态等。  

        2.  验证域名的CNAME是否配置成功。
            1.  在Windows操作系统中，选择“开始  \>  运行“，在弹出框中输入“cmd“，按“Enter“。
            2.  执行以下命令，查询CNAME。如果回显的域名是配置的CNAME，则表示配置成功，示例如[图8](#zh-cn_topic_0110861266_waf_01_0079_fig04371756152219)所示。

                **nslookup www.**_domain_**.com**

                **图 8**  查询CNAME<a name="zh-cn_topic_0110861266_waf_01_0079_fig04371756152219"></a>  
                ![](figures/查询CNAME.png "查询CNAME")




10. 域名接入完成后，单击“下一步“。
11. 单击“完成“，防护域名添加成功。

    用户可在域名列表中查看已添加防护域名的“DNS解析状态“和“工作模式“。

    >![](public_sys-resources/icon-note.gif) **说明：**   
    >-   若用户的服务器在使用其他网络防火墙，请将其关闭或者将WAF的IP网段添加到网络防火墙的IP白名单中。  
    >-   若用户的服务器上已安装个人版安全软件，建议将其更换为企业版安全软件，并将WAF的IP网段添加到该软件的IP白名单中。  
    >-   若防护域名已接入WAF，“DNS解析状态“仍然为“异常“，可单击![](figures/刷新图标.jpg)，刷新状态。  


## 对外协议与源站协议配置规则<a name="section645014318511"></a>

根据您的业务场景的不同，WAF提供灵活的协议类型配置。假设您的网站为www.example.com，WAF可配置如下四种访问模式：

-   HTTP访问模式。如[图9](#fig53041342142615)所示。

    **图 9**  HTTP协议访问模式<a name="fig53041342142615"></a>  
    ![](figures/HTTP协议访问模式.jpg "HTTP协议访问模式")

    >![](public_sys-resources/icon-notice.gif) **注意：**   
    >此种配置表示用户只能通过http://www.example.com访问网站，如果用户通过https://www.example.com访问网站，用户会收到302跳转响应，浏览器跳转到http://www.example.com  

-   HTTPS访问模式，客户端协议全部配置为HTTPS时，当使用HTTP协议访问服务器时，会强制跳转为HTTPS协议，如[图10](#fig7444410153315)所示。

    **图 10**  HTTPS协议访问强制跳转模式<a name="fig7444410153315"></a>  
    ![](figures/HTTPS协议访问强制跳转模式.jpg "HTTPS协议访问强制跳转模式")

    >![](public_sys-resources/icon-notice.gif) **注意：**   
    >-   用户直接通过https://www.example.com访问网站，网站返回正常内容。  
    >-   用户通过http://www.example.com访问网站，用户会收到302跳转响应，浏览器跳转到https://www.example.com。  

-   HTTP/HTTPS分别转发模式。如[图11](#fig3389134713400)所示。

    **图 11**  HTTP/HTTPS分别转发模式<a name="fig3389134713400"></a>  
    ![](figures/HTTP-HTTPS分别转发模式.jpg "HTTP-HTTPS分别转发模式")

    >![](public_sys-resources/icon-notice.gif) **注意：**   
    >-   用户通过http://www.example.com访问网站，网站返回正常内容，没有跳转，网站内容不加密传输。  
    >-   用户通过https://www.example.com访问网站，网站返回正常内容，没有跳转，网站内容加密传输。  

-   使用WAF做HTTPS卸载模式。如[图12](#fig11273129104514)所示。

    **图 12**  使用WAF做HTTPS卸载模式<a name="fig11273129104514"></a>  
    ![](figures/使用WAF做HTTPS卸载模式.jpg "使用WAF做HTTPS卸载模式")

    >![](public_sys-resources/icon-notice.gif) **注意：**   
    >用户通过https://www.example.com访问网站，但是WAF到源站依然使用HTTP协议。  


